<html>

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ÈØäÂÆúÁöÑÊ°åÁêÉ‰πãË∑Ø</title>
    <link rel="manifest" href="./manifest.webmanifest">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/mobile/1.5.0-rc1/jquery.mobile-1.5.0-rc1.min.js"></script>
</head>

<body>
    <style>
        html {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            margin: 0;
            width: 100%;
            min-height: 100dvh;
        }

        .container {
            padding: 20px;
        }

        #container-main {
            display: none;
            opacity: 0;
            transition: opacity 500ms;
        }

        #container-main.open {
            display: block;
            opacity: 1;
        }


        .main {
            margin-top: 40px;
            padding-top: 15px;
        }

        .progress-container {
            width: 100%;
            height: 18px;
            background-color: #ccc;
            border-radius: 15px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .item+.item {
            margin-top: 10px;
        }

        .progress-bar {
            border-radius: 15px;
            position: relative;
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-in-out;
            background-size: 100% 100%;
            color: white;
        }

        .score1-bg {
            background: #ff4d4f !important;
        }

        .score2-bg {
            background: #faad14 !important;
        }

        .score3-bg {
            background: #40a9ff !important;
        }

        .score4-bg {
            background: #52c41a !important;
        }

        .score1-text {
            color: #ff4d4f !important;
        }

        .score2-text {
            color: #faad14 !important;
        }

        .score3-text {
            color: #40a9ff !important;
        }

        .score4-text {
            color: #52c41a !important;
        }

        .progress-bar::after {
            display: block;
            position: absolute;
            /* left: calc(100% - 40px); */
            right: 6px;
            top: 0px;
            font-size: 16px;
            font-weight: bold;
            line-height: 18px;
            content: attr(data-score)"%";

        }

        .item__title {
            font-size: 16px;
        }

        .select-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            position: fixed;
            top: 0px;
            right: 0px;
            width: 100%;
            background: #ffffffcc;
            padding-top: 15px;
            padding-bottom: 15px;
            padding-right: 20px;
            z-index: 1;
            gap: 12px;
        }

        .grow-up-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0072c4;
            color: white;
            text-align: center;
            padding: 6px 12px;
            white-space: nowrap;
            border-radius: 8px;
            cursor: pointer;
            /* transform: translateY(-2px); */
        }

        select {
            font-size: 16px;
            border: 1px solid;
            padding: 10px;
        }

        .ui-selectmenu-button-text {
            display: none;
        }

        .ui-loader-header {
            display: none;
        }

        .total {
            display: flex;
            flex-wrap: wrap;
            margin-top: 30px;
            border-top: 1px solid;
            padding-bottom: 10px;
        }

        .total__item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-basis: 25%;
            border: 1px solid;
            box-sizing: border-box;
            border-top: none;
            padding: 3px;
        }

        .total-item__name {}

        .total-item__count {
            font-weight: bolder;
        }

        .file-container {
            position: fixed;
            display: none;
            align-items: center;
            z-index: 50;
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            background: white;
            padding: 15px;
            font-size: 16px;
            box-sizing: border-box;
            border: 2px solid black;
        }

        .close {
            position: absolute;
            right: 10px;
            content: "X";
            font-size: 20px;
            font-weight: bolder;
            cursor: pointer;
            padding: 10px;
        }

        /* Ê≠∑Âè≤ */
        .history-main {
            display: none;
            position: absolute;
            opacity: 0;
            top: 0;
            left: 100%;
            width: 100%;
            z-index: 9;
            background: white;
            margin-top: 55px;
            padding: 20px;
            box-sizing: border-box;
            transition: left 500ms, opacity 2s;
        }

        .history-main.open {
            display: block;
            left: 0;
            opacity: 1;
        }

        .close-history {
            position: absolute;
            left: 30px;
            content: "X";
            font-size: 20px;
            font-weight: bolder;
            cursor: pointer;
            padding: 10px;
        }

        .history-item__header {
            position: relative;
            padding: 6px;
            border: 2px solid #666;
            border-radius: 10px;
        }

        .history-item__header.open {
            border-bottom-left-radius: 0px;
            border-bottom-right-radius: 0px;
            border-bottom: none;
        }

        .history-collapse-func {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 20px;
            font-size: 20px;
            font-weight: bolder;
            margin-bottom: 16px;
        }

        .history-collapse-func--open,
        .history-collapse-func--close {
            position: relative;
            width: 30px;
            height: 30px;
            transition: transform 0.5s;
        }

        .history-collapse-func--open::before,
        .history-collapse-func--close::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 4px;
            top: 13px;
            background: black;
        }

        .history-collapse-func--open::after {
            content: "";
            position: absolute;
            width: 4px;
            height: 100%;
            left: 13px;
            background: black;
        }

        .history-item__header[has-record]::before,
        .history-item__header[has-record]::after {
            position: absolute;
            background: black;
            content: "";
            transition: transform .5s;

        }

        .history-item__header[has-record]::before {
            width: 16px;
            height: 2px;
            right: 20px;
            bottom: 27px;
        }

        .history-item__header[has-record]::after {
            width: 2px;
            height: 16px;
            right: 27px;
            bottom: 20px;
        }

        .history-item__header.open::before {
            transform: rotate(360deg);
        }

        .history-item__header.open::after {
            transform: rotate(270deg);
        }

        .history-item-header__info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 6px;
        }

        .history-info-bar {
            min-width: 80px;
            border-radius: 10px;
            padding: 3px;
            text-align: center;
            font-weight: bolder;
            color: white;
            font-size: 18px;
        }

        .history-info-bar--diff {
            min-width: 30px;
            font-size: 22px;
        }

        .history-item__content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
            border: 2px solid #666;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            padding: 10px;
            background: #ddd;
            border-top: none;
        }

        .history-record-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-basis: calc(50% - 5px);
            background: white;
            border-radius: 10px;
        }


        .record-item__info-bar {
            min-width: 50px;
            border-radius: 10px;
            padding: 3px;
            text-align: center;
            font-weight: bolder;
        }

        .history-item+.history-item {
            margin-top: 10px;
        }
    </style>

    <div class="container open" id="container-main">
        <div class="select-container" id="main-select-container">
            <div class="grow-up-btn">ÊàêÈï∑</div>
            <select name="È°ûÂà•" id="type-select">
                <option value="ÂÖ®ÈÉ®" selected>ÂÖ®ÈÉ®</option>
                <option value="Âü∫Á§é">üå± Âü∫Á§é</option>
                <option value="ÊîªÊìä">‚öîÔ∏è ÊîªÊìä</option>
                <option value="Èò≤ÂÆà">‚òØÔ∏è Èò≤ÂÆà</option>
                <option value="ËÖ≥Ê≠•">üëü ËÖ≥Ê≠•</option>
                <option value="ÈäúÊé•">üß© ÈäúÊé•</option>
                <option value="ÁôºÁêÉ">‚ñ∂Ô∏è ÁôºÁêÉ</option>
                <option value="Êé•ÁêÉ">üîç Êé•ÁêÉ</option>
                <option value="Á≠ñÁï•">ü•ã Á≠ñÁï•</option>
            </select>

            <select name="È°ØÁ§∫Ê®°Âºè" id="view-select">
                <option value="È†êË®≠" selected>È†êË®≠</option>
                <option value="ÁÜüÁ∑¥Â∫¶Áî±È´òÂà∞‰Ωé">ÁÜüÁ∑¥Â∫¶ Áî±È´òÂà∞‰Ωé</option>
                <option value="ÁÜüÁ∑¥Â∫¶Áî±‰ΩéÂà∞È´ò">ÁÜüÁ∑¥Â∫¶ Áî±‰ΩéÂà∞È´ò</option>
            </select>
        </div>

        <div class="main" id="main">
        </div>

        <div class="total">
            <div class="total__item" style="flex-basis: 100%;justify-content: center;" data-type="ÂÖ®ÈÉ®">
                <div class="total-item__name" style="margin-right: 10px;">üèì ÂÖ®ÈÉ®</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="Âü∫Á§é">
                <div class="total-item__name">üå± Âü∫Á§é</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="ÊîªÊìä">
                <div class="total-item__name">‚öîÔ∏è ÊîªÊìä</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="Èò≤ÂÆà">
                <div class="total-item__name">‚òØÔ∏è Èò≤ÂÆà</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="ËÖ≥Ê≠•">
                <div class="total-item__name">üëü ËÖ≥Ê≠•</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="ÈäúÊé•">
                <div class="total-item__name">üß© ÈäúÊé•</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="ÁôºÁêÉ">
                <div class="total-item__name">‚ñ∂Ô∏è ÁôºÁêÉ</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="Êé•ÁêÉ">
                <div class="total-item__name">üîç Êé•ÁêÉ</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" data-type="Á≠ñÁï•">
                <div class="total-item__name">ü•ã Á≠ñÁï•</div>
                <div class="total-item__count"></div>
            </div>
            <div class="total__item" style="flex-basis: 100%;justify-content: center;" data-type="Âπ≥Âùá">
                <div class="total-item__name" style="margin-right: 10px;">‚öñÔ∏è Âπ≥ÂùáÁÜüÁ∑¥Â∫¶</div>
                <div class="total-item__count"></div><span> %</span>
            </div>
        </div>
    </div>

    <div class="history-main" id="history-main">
        <div class="select-container" id="history-select-container">
            <div class="close-history">X</div>
            <select name="Ê≠∑Âè≤-È°ûÂà•" id="history-type-select">
                <option value="ÂÖ®ÈÉ®">ÂÖ®ÈÉ®</option>
                <option value="ÊúâËÆäÂãï" selected>ÊúâËÆäÂãï</option>
                <option value="ÁÑ°ËÆäÂãï">ÁÑ°ËÆäÂãï</option>
            </select>

            <select name="Ê≠∑Âè≤-È°ØÁ§∫Ê®°Âºè" id="history-view-select">
                <option value="È†êË®≠">È†êË®≠</option>
                <option value="ËÆäÂãïÂπÖÂ∫¶Áî±È´òÂà∞‰Ωé" selected>ËÆäÂãïÂπÖÂ∫¶ Áî±È´òÂà∞‰Ωé</option>
                <option value="ËÆäÂãïÂπÖÂ∫¶Áî±‰ΩéÂà∞È´ò">ËÆäÂãïÂπÖÂ∫¶ Áî±‰ΩéÂà∞È´ò</option>
            </select>
        </div>

        <div class="history-collapse-func">
            <div class="history-collapse-func--open"></div>
            <div class="history-collapse-func--close"></div>
        </div>

        <div class="history-list" id="history-list">

        </div>
    </div>

    <div class="file-container">
        <input type="file" name="import-file" accept=".txt">
        <div class="close">X</div>
    </div>

    <script>
        const exportMainKeyWordStart = "===‰∏ªË¶ÅË≥áÊñôstart===";
        const exportMainKeyWordEnd = "===‰∏ªË¶ÅË≥áÊñôend===";
        const exportAvgKeyWordStart = "===ÂéüÂßãÂπ≥ÂùáÁÜüÁ∑¥Â∫¶start===";
        const exportAvgKeyWordEnd = "===ÂéüÂßãÂπ≥ÂùáÁÜüÁ∑¥Â∫¶end===";
        const exportHistoryKeyWordStart = "===Ê≠∑Âè≤Ë≥áÊñôstart===";
        const exportHistoryKeyWordEnd = "===Ê≠∑Âè≤Ë≥áÊñôend===";
        var typeSelectValue = "ÂÖ®ÈÉ®";
        var viewSelectValue = "È†êË®≠";
        var dataList = getDataList() ?? [];

        // var dataList = [
        //     { id: "d1", name: '123', score: 20 },
        //     { id: "d2", name: '456', score: 60 },
        //     { id: "d3", name: '123', score: 20 },
        //     { id: "d4", name: '456', score: 80 }
        // ];

        renderDataByCondition(typeSelectValue, viewSelectValue, dataList);

        // Ë®àÁÆóÁ∏ΩÊï∏
        $(".total__item[data-type]").each((index, element) => {
            var dataType = $(element).attr("data-type");
            var countElement = $(element).find(".total-item__count");

            if ("ÂÖ®ÈÉ®" === dataType) {
                countElement.text(dataList.length);
            }
            else {
                countElement.text(dataList.filter(x => x.type === dataType).length);
            }
        });
        const totalAvg = calculateTotalAvg(dataList);
        $(".total__item[data-type=Âπ≥Âùá] > .total-item__count").text(totalAvg);

        function calculateTotalAvg(dataList) {
            const totalScore = dataList
                .map(x => Number(x.score))
                .reduce((a, b) => a + b, 0);
            return (Math.round(totalScore / dataList.length * 100) / 100);
        }


        document.getElementById("type-select").addEventListener("change", function () {
            typeSelectValue = this.value;
            renderDataByCondition(typeSelectValue, viewSelectValue, dataList);
        });

        document.getElementById("view-select").addEventListener("change", function () {
            viewSelectValue = this.value;
            renderDataByCondition(typeSelectValue, viewSelectValue, dataList);
        });

        function renderDataByCondition(typeSelectValue, viewSelectValue, dataList) {
            var resultDataList = [...dataList];

            if ("ÂÖ®ÈÉ®" !== typeSelectValue) {
                resultDataList = resultDataList.filter(x => x.type === typeSelectValue);
            }

            if ("È†êË®≠" === viewSelectValue) {
                renderData(resultDataList);
            }
            else if ("ÁÜüÁ∑¥Â∫¶Áî±‰ΩéÂà∞È´ò" === viewSelectValue) {
                renderData(resultDataList.sort((a, b) => a.score - b.score));
            }
            else if ("ÁÜüÁ∑¥Â∫¶Áî±È´òÂà∞‰Ωé" === viewSelectValue) {
                renderData(resultDataList.sort((a, b) => b.score - a.score));
            }

            $('html, body').animate({ scrollTop: 0 }, 'fast');

        }

        function renderData(dataList) {
            const main = document.getElementById("main");
            main.innerHTML = "";

            dataList.forEach(data => {
                var classNameForStyle = getProgressBarClassName(data.score, "bg");
                var item = document.createElement("div");
                item.className = "item";
                item.innerHTML = `
                <div class="item__title">${data.name}</div>
                <div class="progress-container">
                    <div id="${data.id}" class="progress-bar ${classNameForStyle}" data-name="${data.name}" data-score="${data.score}" data-origin-order="${data.originOrder}"></div>
                </div>
                `;

                main.append(item);

            });

            setTimeout(function () {
                dataList.forEach(data => {
                    document.getElementById(data.id).style.width = data.score + "%";
                });
            }, 50);
        }

        // ‰øÆÊîπÂàÜÊï∏
        $(".main").on("taphold", ".progress-container", function (event) {

            var target = $(event.currentTarget);
            var targetProgressBar = target.find(".progress-bar[data-score]");
            var id = targetProgressBar.attr("id");
            var score = window.prompt("Ë´ãËº∏ÂÖ•ÂàÜÊï∏", targetProgressBar.attr("data-score"));
            if (score) {

                // Ê≠∑Á®ã
                const oldScore = Number(targetProgressBar.attr("data-score")); // ‰øÆÊîπÂâçÁöÑÁÜüÁ∑¥Â∫¶
                recordSkillHistory(id, targetProgressBar.attr("data-name"), oldScore, score); // Ë®òÈåÑ‰øÆÊîπÊ≠∑Á®ã
                // end of Ê≠∑Á®ã

                targetProgressBar.css("width", score + "%");
                targetProgressBar.attr("data-score", score);
                targetProgressBar.removeClass("score1-bg score2-bg score3-bg score4-bg").addClass(getProgressBarClassName(score, "bg"));

                // Â∞áË≥áÊñôÂ°ûÂõû localstorage
                var targetData = { ...dataList.find(x => x.id === id), score: score };
                var resultDataList = [...[...dataList].filter(x => x.id !== id), targetData];

                window.localStorage.setItem("dataList", JSON.stringify(resultDataList));
                dataList = getDataList() ?? [];
                const totalAvg = calculateTotalAvg(dataList);
                $(".total__item[data-type=Âπ≥Âùá] > .total-item__count").text(totalAvg);
            }
        });

        // ÂåØÂÖ•ÊàñÂåØÂá∫
        $('#main-select-container,#history-select-container').on('taphold', function () {

            var func = prompt("ÂåØÂÖ•ÈÇÑÊòØÂåØÂá∫Âóé?", "ÂåØÂá∫");
            if ("ÂåØÂá∫" === func) {

                let exportContent = "";
                exportContent += (exportAvgKeyWordStart + window.localStorage.getItem('originTotalAvg') + exportAvgKeyWordEnd); // ÂéüÂßãÁÜüÁ∑¥Â∫¶Âπ≥ÂùáË≥áÊñô
                exportContent += (exportMainKeyWordStart + window.localStorage.getItem("dataList") + exportMainKeyWordEnd); // ‰∏ªË¶ÅË≥áÊñô
                exportContent += (exportHistoryKeyWordStart + window.localStorage.getItem('skillHistory') + exportHistoryKeyWordEnd); // Ê≠∑Âè≤Ë≥áÊñô

                const blob = new Blob([exportContent], { type: "text/plain" });

                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = new Date().toLocaleString() + "_ÈØäÂÆúÁöÑÊ°åÁêÉ‰πãË∑ØÂÇô‰ªΩ.txt"; // Desired filename
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            else if ("ÂåØÂÖ•" === func) {
                $(".file-container").css("display", "flex");
            }
        });

        // ÂåØÂÖ•Ê™îÊ°à
        $("[name=import-file]").on('change', (event) => {

            const selectedFile = event.target.files[0]; // Get the first selected file

            if (selectedFile) {
                const reader = new FileReader();

                reader.onload = (e) => {
                    const fileContent = e.target.result; // The content of the file
                    if (fileContent && fileContent.length > 0) {

                        const originTotalAvgStr = fileContent.slice(fileContent.indexOf(exportAvgKeyWordStart) + exportAvgKeyWordStart.length, fileContent.indexOf(exportAvgKeyWordEnd));
                        window.localStorage.setItem("originTotalAvg", originTotalAvgStr);

                        const dataListStr = fileContent.slice(fileContent.indexOf(exportMainKeyWordStart) + exportMainKeyWordStart.length, fileContent.indexOf(exportMainKeyWordEnd));
                        window.localStorage.setItem("dataList", dataListStr);

                        const historyStr = fileContent.slice(fileContent.indexOf(exportHistoryKeyWordStart) + exportHistoryKeyWordStart.length, fileContent.indexOf(exportHistoryKeyWordEnd));
                        window.localStorage.setItem("skillHistory", historyStr);

                        alert("ÂåØÂÖ•Ë≥áÊñôÊàêÂäü")
                        window.location.reload();
                    }
                    // You can now process or display fileContent
                };

                // Choose how to read the file:
                // reader.readAsText(selectedFile); // Reads as plain text
                // reader.readAsDataURL(selectedFile); // Reads as a data URL (useful for images)
                // reader.readAsArrayBuffer(selectedFile); // Reads as an ArrayBuffer
                reader.readAsText(selectedFile); // Example: Reading as text
            }
        });

        $(".file-container").on("click", ".close", () => {
            $(".file-container").fadeOut()
        });

        // ÈñãÂïüÊ≠∑Âè≤
        $(".grow-up-btn").on("click", function () {
            initHistoryPage();
            $("#history-main").show("fast", function () {
                $("#history-main").addClass("open");
                $("#container-main").hide();
            });
            $("#container-main").removeClass("open");
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        });

        $(".history-main").on("click", ".close-history", () => {
            $("#history-main").removeClass("open");
            $("#container-main").show();
            $('html, body').animate({ scrollTop: 0 }, 'fast');
            setTimeout(function () {
                $("#history-main").hide();
                $("#container-main").addClass("open");
            }, 400);
        });

        function getDataList() {
            var dataList = window.localStorage.getItem("dataList");
            if (dataList === null) {
                dataList = [
                    { name: "üå± Âü∫Á§é - Ê≠£ÊâãÂ∞çÊâì", score: 83, type: "Âü∫Á§é", id: "basic-1", originOrder: 0 },
                    { name: "üå± Âü∫Á§é - Ê≠£ÊâãÂàáÁêÉ", score: 73, type: "Âü∫Á§é", id: "basic-2", originOrder: 1 },
                    { name: "üå± Âü∫Á§é - ÂèçÊâãÂ∞çÊâì", score: 79, type: "Âü∫Á§é", id: "basic-3", originOrder: 2 },
                    { name: "üå± Âü∫Á§é - ÂèçÊâãÂàáÁêÉ", score: 71, type: "Âü∫Á§é", id: "basic-4", originOrder: 3 },

                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÂπ≥Êãâ", score: 80, type: "ÊîªÊìä", id: "attack-1", originOrder: 4 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£Êâã‰∏ãÊóãÊãâ", score: 72, type: "ÊîªÊìä", id: "attack-2", originOrder: 5 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÊÆ∫ÁêÉ(È´òÁêÉÂπ≥ÁêÉ)", score: 71, type: "ÊîªÊìä", id: "attack-3", originOrder: 6 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÊÆ∫ÁêÉ(‰∏ÄËà¨È´òÂ∫¶Âπ≥ÁêÉ)", score: 78, type: "ÊîªÊìä", id: "attack-4", originOrder: 7 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÊÆ∫ÁêÉ(È´òÁêÉ‰∏ãÊóã)", score: 68, type: "ÊîªÊìä", id: "attack-5", originOrder: 8 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÊåëÁêÉ", score: 65, type: "ÊîªÊìä", id: "attack-6", originOrder: 9 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÂàáÁêÉÂäàÈï∑", score: 60, type: "ÊîªÊìä", id: "attack-7", originOrder: 10 },
                    { name: "‚öîÔ∏è ÊîªÊìä - Ê≠£ÊâãÊíáÁõ¥Á∑öÈï∑ÁêÉ", score: 50, type: "ÊîªÊìä", id: "attack-8", originOrder: 11 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÂπ≥Êãâ", score: 70, type: "ÊîªÊìä", id: "attack-9", originOrder: 12 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâã‰∏ãÊóãÊãâ", score: 68, type: "ÊîªÊìä", id: "attack-10", originOrder: 13 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÊÆ∫ÁêÉ(È´òÁêÉÂπ≥ÁêÉ)", score: 70, type: "ÊîªÊìä", id: "attack-11", originOrder: 14 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÊÆ∫ÁêÉ(‰∏ÄËà¨È´òÂ∫¶Âπ≥ÁêÉ)", score: 73, type: "ÊîªÊìä", id: "attack-12", originOrder: 15 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÊÆ∫ÁêÉ(È´òÁêÉ‰∏ãÊóã)", score: 69, type: "ÊîªÊìä", id: "attack-13", originOrder: 16 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÊåëÁêÉ", score: 60, type: "ÊîªÊìä", id: "attack-14", originOrder: 17 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÂàáÁêÉÂäàÈï∑", score: 65, type: "ÊîªÊìä", id: "attack-15", originOrder: 18 },
                    { name: "‚öîÔ∏è ÊîªÊìä - ÂèçÊâãÊì∞ÁêÉ", score: 40, type: "ÊîªÊìä", id: "attack-16", originOrder: 19 },

                    { name: "‚òØÔ∏è Èò≤ÂÆà - Ê≠£ÊâãÂàáÁêÉÊì∫Áü≠", score: 60, type: "Èò≤ÂÆà", id: "defend-1", originOrder: 20 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - Ê≠£ÊâãÊìãÊãâÁêÉ(‰∏ÄËà¨È´òÂ∫¶)", score: 71, type: "Èò≤ÂÆà", id: "defend-2", originOrder: 21 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - Ê≠£ÊâãÊìãÊãâÁêÉ(ÂçäÈ´ò)", score: 65, type: "Èò≤ÂÆà", id: "defend-3", originOrder: 22 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - Ê≠£ÊâãÊìãÊÆ∫ÁêÉ", score: 67, type: "Èò≤ÂÆà", id: "defend-4", originOrder: 23 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - ÂèçÊâãÂàáÁêÉÊì∫Áü≠", score: 63, type: "Èò≤ÂÆà", id: "defend-5", originOrder: 24 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - ÂèçÊâãÊìãÊãâÁêÉ(‰∏ÄËà¨È´òÂ∫¶)", score: 83, type: "Èò≤ÂÆà", id: "defend-6", originOrder: 25 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - ÂèçÊâãÊìãÊãâÁêÉ(ÂçäÈ´ò)", score: 74, type: "Èò≤ÂÆà", id: "defend-7", originOrder: 26 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - ÂèçÊâãÊìãÊÆ∫ÁêÉ", score: 72, type: "Èò≤ÂÆà", id: "defend-8", originOrder: 27 },
                    { name: "‚òØÔ∏è Èò≤ÂÆà - ÂèçÊâãÂÅ¥Âàá", score: 38, type: "Èò≤ÂÆà", id: "defend-9", originOrder: 28 },

                    { name: "üëü ËÖ≥Ê≠• - Âõ∫ÂÆöÂÖ©Èªû(Ê≠£Âèç)", score: 75, type: "ËÖ≥Ê≠•", id: "step-1", originOrder: 29 },
                    { name: "üëü ËÖ≥Ê≠• - Âõ∫ÂÆö‰∏âÈªû(Ê≠£ÂèçÂÅ¥Ë∫´)", score: 66, type: "ËÖ≥Ê≠•", id: "step-2", originOrder: 30 },
                    { name: "üëü ËÖ≥Ê≠• - ‰∏çÂÆöÈªû(Ê≠£Âèç)", score: 70, type: "ËÖ≥Ê≠•", id: "step-3", originOrder: 31 },
                    { name: "üëü ËÖ≥Ê≠• - ‰∏çÂÆöÈªû(ÂÖ®Âè∞)", score: 64, type: "ËÖ≥Ê≠•", id: "step-4", originOrder: 32 },

                    { name: "üß© ÈäúÊé• - Ê≠£Êâã‰ΩçÊé•ÁêÉ(Èï∑ÁêÉ->ÊÆ∫ÁêÉÊàñÊãâÁêÉÔºåÁü≠ÁêÉ->ÂàáÁêÉ)", score: 62, type: "ÈäúÊé•", id: "connect-1", originOrder: 33 },
                    { name: "üß© ÈäúÊé• - ÂèçÊâã‰ΩçÊé•ÁêÉ(Èï∑ÁêÉ->ÊÆ∫ÁêÉÊàñÊãâÁêÉÔºåÁü≠ÁêÉ->ÂàáÁêÉ)", score: 62, type: "ÈäúÊé•", id: "connect-2", originOrder: 34 },

                    { name: "‚ñ∂Ô∏è ÁôºÁêÉ - ÁôºÂ∑¶‰∏äÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 65, type: "ÁôºÁêÉ", id: "start-1", originOrder: 35 },
                    { name: "‚ñ∂Ô∏è ÁôºÁêÉ - ÁôºÂ∑¶‰∏ãÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 65, type: "ÁôºÁêÉ", id: "start-2", originOrder: 36 },
                    { name: "‚ñ∂Ô∏è ÁôºÁêÉ - ÁôºÂè≥‰∏äÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 70, type: "ÁôºÁêÉ", id: "start-3", originOrder: 37 },
                    { name: "‚ñ∂Ô∏è ÁôºÁêÉ - ÁôºÂè≥‰∏ãÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 72, type: "ÁôºÁêÉ", id: "start-4", originOrder: 38 },
                    { name: "‚ñ∂Ô∏è ÁôºÁêÉ - ÁôºÁü≠Á©∫", score: 70, type: "ÁôºÁêÉ", id: "start-5", originOrder: 39 },
                    { name: "‚ñ∂Ô∏è ÁôºÁêÉ - ÁôºÂø´ÈÄüÁêÉ", score: 66, type: "ÁôºÁêÉ", id: "start-6", originOrder: 40 },

                    // { name: "üîç Êé•ÁêÉ - Êé•Â∑¶Êóã/Âè≥Êóã+‰∏äÊóã/‰∏ãÊóã+Èï∑ÁêÉ/Áü≠ÁêÉ+Áü≠Á©∫+Âø´ÈÄüÁêÉÔºå‰∏¶ËÉΩÂ§†‰ΩøÁî®ÈÄÜÊóãËΩâ/È†ÜÊóãËΩâÊé•ÁêÉ", score: 65, type: "Êé•ÁêÉ", id: "catch-1", originOrder: 41 },
                    { name: "üîç Êé•ÁêÉ - Êé•Â∑¶‰∏äÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 68, type: "Êé•ÁêÉ", id: "catch-1", originOrder: 41 },
                    { name: "üîç Êé•ÁêÉ - Êé•Â∑¶‰∏ãÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 71, type: "Êé•ÁêÉ", id: "catch-2", originOrder: 42 },
                    { name: "üîç Êé•ÁêÉ - Êé•Âè≥‰∏äÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 66, type: "Êé•ÁêÉ", id: "catch-3", originOrder: 43 },
                    { name: "üîç Êé•ÁêÉ - Êé•Âè≥‰∏ãÊóãÈï∑ÁêÉ/Áü≠ÁêÉ", score: 69, type: "Êé•ÁêÉ", id: "catch-4", originOrder: 44 },
                    { name: "üîç Êé•ÁêÉ - Êé•Áü≠Á©∫", score: 70, type: "Êé•ÁêÉ", id: "catch-5", originOrder: 45 },
                    { name: "üîç Êé•ÁêÉ - Êé•Âø´ÈÄüÁêÉ", score: 65, type: "Êé•ÁêÉ", id: "catch-6", originOrder: 46 },

                    { name: "ü•ã Á≠ñÁï• - ÁôºÁü≠Á©∫->ÊÆ∫ÁêÉ", score: 70, type: "Á≠ñÁï•", id: "strategy-1", originOrder: 47 }
                ];
                const toalAvg = calculateTotalAvg(dataList);
                window.localStorage.setItem("originTotalAvg", toalAvg);
                window.localStorage.setItem("dataList", JSON.stringify(dataList));
            } else {
                dataList = JSON.parse(dataList);
            }

            dataList = [...dataList].sort((a, b) => a.originOrder - b.originOrder);

            return dataList;
        }

        function getProgressBarClassName(score, type) {
            var classNameForStyle = "";
            if (score < 60) {
                classNameForStyle = "score1";
            }
            else if (score < 70) {
                classNameForStyle = "score2";
            }
            else if (score < 80) {
                classNameForStyle = "score3";
            }
            else if (score <= 100) {
                classNameForStyle = "score4";
            }

            if (type === "bg" && classNameForStyle) {
                classNameForStyle += "-bg";
            }
            else if (type === "text" && classNameForStyle) {
                classNameForStyle += "-text";
            }

            return classNameForStyle;
        }

        // Ê≠∑Âè≤ÂçÄÂ°ä
        let historyTypeSelectValue = "ÊúâËÆäÂãï";
        let historyViewSelectValue = "ËÆäÂãïÂπÖÂ∫¶Áî±È´òÂà∞‰Ωé";

        let historyData = {};

        function recordSkillHistory(skillId, skillName, oldScore, newScore) {
            const history = JSON.parse(window.localStorage.getItem('skillHistory')) || {};
            const timestamp = new Date().toISOString();

            if (!history[skillId]) {
                history[skillId] = { name: skillName, list: [] };
            }

            history[skillId].list.push({
                name: skillName,
                time: timestamp,
                change: newScore - oldScore,
                newScore: newScore,
            });

            localStorage.setItem('skillHistory', JSON.stringify(history));
        }

        function initHistoryPage() {
            // $("#history-main").empty();
            historyData = JSON.parse(window.localStorage.getItem('skillHistory')) ?? {};
            renderHistoryByCondition(historyTypeSelectValue, historyViewSelectValue, historyData, dataList);
            openAllRecord();
            // $("[history-source-id]").addClass("open");
        }

        document.getElementById("history-type-select").addEventListener("change", function () {
            historyTypeSelectValue = this.value;
            renderHistoryByCondition(historyTypeSelectValue, historyViewSelectValue, historyData, dataList);
        });

        document.getElementById("history-view-select").addEventListener("change", function () {
            historyViewSelectValue = this.value;
            renderHistoryByCondition(historyTypeSelectValue, historyViewSelectValue, historyData, dataList);
        });

        function renderHistoryByCondition(historyTypeSelectValue, historyViewSelectValue, historyData, dataList) {
            var resultDataList = [...dataList];

            if ("ÊúâËÆäÂãï" === historyTypeSelectValue) {
                resultDataList = resultDataList.filter(x => !!historyData[x.id]);
            }
            else if ("ÁÑ°ËÆäÂãï" === historyTypeSelectValue) {
                resultDataList = resultDataList.filter(x => !historyData[x.id]);
            }

            if ("È†êË®≠" === historyViewSelectValue) {
                renderHistory(historyData, resultDataList);
            }
            else {
                resultDataList = resultDataList.map(x => {
                    let diff = 0;
                    if (!!historyData[x.id]) {
                        diff = historyData[x.id].list
                            .map(x => Number(x.change))
                            .reduce((a, b) => a + b, 0);
                    }
                    return { ...x, diff: diff }
                });

                if ("ËÆäÂãïÂπÖÂ∫¶Áî±‰ΩéÂà∞È´ò" === historyViewSelectValue) {
                    renderHistory(historyData, resultDataList.sort((a, b) => a.diff - b.diff));
                }
                else if ("ËÆäÂãïÂπÖÂ∫¶Áî±È´òÂà∞‰Ωé" === historyViewSelectValue) {
                    renderHistory(historyData, resultDataList.sort((a, b) => b.diff - a.diff));
                }
            }

            const originTotalAvg = Number(window.localStorage.getItem("originTotalAvg"));
            const currentTotalAvg = calculateTotalAvg(dataList);
            let diffAvg = currentTotalAvg - originTotalAvg;
            diffAvg = (Math.round(diffAvg * 100) / 100);
            var totalItem = `
            <div class="history-item" style="border-top: 2px solid #666;padding-top: 15px;margin-top: 15px;">
                <div class="history-item__header" style="border-width: 4px;">
                    <div class="item__title">‚öñÔ∏è Âπ≥ÂùáÁÜüÁ∑¥Â∫¶</div>
                    <div class="history-item-header__info">
                        <div class="history-info-bar history-info-bar--before $originScoreClass$">$originScore$</div>
                        ${diffAvg !== 0 ?
                    `       <div class="history-info-bar history-info-bar--diff $diffScoreClass$">$diffScore$</div>
                            <div class="history-info-bar history-info-bar--after $currentScoreClass$">$currentScore$</div>`
                    : ""
                }
                    </div>
                </div>
            </div>
            `;
            if (diffAvg === 0) {
                totalItem = totalItem
                    .replace("$originScoreClass$", getProgressBarClassName(currentTotalAvg, "bg"))
                    .replace("$originScore$", currentTotalAvg);
            }
            else {
                totalItem = totalItem
                    .replace("$originScoreClass$", getProgressBarClassName(originTotalAvg, "bg"))
                    .replace("$originScore$", originTotalAvg)
                    .replace("$diffScoreClass$", getProgressBarClassName(currentTotalAvg, "text"))
                    .replace("$diffScore$", diffAvg > 0 ? "+" + diffAvg : diffAvg)
                    .replace("$currentScoreClass$", getProgressBarClassName(currentTotalAvg, "bg"))
                    .replace("$currentScore$", currentTotalAvg);
            }
            $("#history-list").append(totalItem);

            $('html, body').animate({ scrollTop: 0 }, 'fast');
        }

        function renderHistory(historyData, dataList) {
            $("#history-list").empty();

            dataList.forEach(data => {

                const targetRecord = historyData[data.id];

                // ÊúâÁ¥ÄÈåÑ
                let originScore = 0;
                let diffTotal = 0;
                let content = "";
                if (targetRecord) {
                    let recordList = targetRecord.list;
                    recordList = [...recordList]
                        .sort((a, b) => new Date(a.time) - new Date(b.time))
                        .map(x => ({ ...x, time: new Date(x.time).toLocaleDateString() }));

                    content = $(`<div class="history-item__content" history-source-id="${data.id}">`);
                    let recordListHtml = "";

                    recordList.forEach(record => {
                        diffTotal += Number(record.change);
                        let recordItem = `
                            <div class="history-record-item">
                                <div class="record-item__text">${record.time}</div>
                                <div class="record-item__info-bar">${record.change > 0 ? "+" : ""}${record.change}</div>
                            </div>
                        `;
                        recordListHtml += recordItem;
                    });

                    content.append(recordListHtml);
                }

                var historyItem = $("<div class='history-item'>");
                var historyItemHeader = `
                    <div class="history-item__header" history-id="$historyID$" ${!!targetRecord ? "has-record" : ""}>
                        <div class="item__title">$title$</div>
                        <div class="history-item-header__info">
                            <div class="history-info-bar history-info-bar--before $originScoreClass$">$originScore$</div>
                            ${diffTotal !== 0 ?
                        `       <div class="history-info-bar history-info-bar--diff $diffScoreClass$">$diffScore$</div>
                                <div class="history-info-bar history-info-bar--after $currentScoreClass$">$currentScore$</div>`
                        : ""
                    }
                        </div>
                    </div>
                `;

                historyItemHeader = historyItemHeader
                    .replace("$historyID$", data.id)
                    .replace("$title$", data.name)

                if (diffTotal === 0) {
                    historyItemHeader = historyItemHeader
                        .replace("$originScoreClass$", getProgressBarClassName(data.score, "bg"))
                        .replace("$originScore$", data.score);
                }
                else {
                    originScore = data.score - diffTotal;
                    historyItemHeader = historyItemHeader
                        .replace("$originScoreClass$", getProgressBarClassName(originScore, "bg"))
                        .replace("$originScore$", originScore)
                        .replace("$diffScoreClass$", getProgressBarClassName(data.score, "text"))
                        .replace("$diffScore$", diffTotal > 0 ? "+" + diffTotal : diffTotal)
                        .replace("$currentScoreClass$", getProgressBarClassName(data.score, "bg"))
                        .replace("$currentScore$", data.score);
                }

                historyItem.append(historyItemHeader);

                if (targetRecord) {
                    let currentScore = originScore;
                    content.find(".record-item__info-bar").each((index, element) => {
                        const change = Number($(element).text());
                        currentScore += change;
                        $(element).addClass(getProgressBarClassName(currentScore, "text"));
                    });

                    historyItem.append(content);
                }

                $("#history-list").append(historyItem);
                $(".history-item__content").hide();
            });
        }

        function openAllRecord() {
            $("[history-id]:not(.open)").trigger("click");
        }

        function closeAllRecord() {
            $("[history-id].open").trigger("click");
        }

        $(".history-main").on("click", ".history-item__header[history-id][has-record]", function (event) {
            var currentTarget = $(event.currentTarget);
            var historyID = currentTarget.attr("history-id");
            if (historyID) {
                var content = $("[history-source-id=" + historyID + "]");
                currentTarget.toggleClass('open', !content.is(':visible'));
                $("[history-source-id=" + historyID + "]").slideToggle();
            }
        });

        let openFuncRotateDeg = 0;
        let closeFuncRotateDeg = 0;
        $(".history-main").on("click", ".history-collapse-func--open", function (event) {
            openFuncRotateDeg += 360;
            $(".history-collapse-func--open").css("transform", "rotate(" + openFuncRotateDeg + "deg)");
            openAllRecord();
        });

        $(".history-main").on("click", ".history-collapse-func--close", function (event) {
            closeFuncRotateDeg += 360;
            $(".history-collapse-func--close").css("transform", "rotate(" + closeFuncRotateDeg + "deg)");
            closeAllRecord();
        });
    </script>
</body>



</html>